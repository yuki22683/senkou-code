# CLAUDE.md - プロジェクトルール

## 修正ミス発生時のルール

修正ミスが発生した場合は、必ず以下を行うこと：

1. **再発防止策をこのファイルに記述する**
2. 同じミスを二度と繰り返さない

---

## 再発防止策

### 1. git checkout 実行時の注意
- `git checkout -- data/lessons/*.ts` を実行すると、以前適用した修正（虫食い化、コメント追加など）が全て消える
- git checkout 後は必ず以下のスクリプトを再実行すること：
  1. `node scripts/fix-holey-v2.mjs` - 虫食い化
  2. `node scripts/add-hint-comments.mjs` - コメント追加
- index.tsのケーシング修正（Java3→java3, C2→c2など）も再適用が必要

### 2. bashファイルのechoクォート
- `echo "___"` の閉じクォートは必ずエスケープする: `echo \"___\"`
- 修正後は `grep 'echo \\"___"[^\\]'` で未修正箇所がないか確認

### 3. 虫食い行の上のコメント
- 全ての虫食い行（`___`を含む行）の上には、その行が何をするかを説明するコメントが必要
- 例：
  - `// 標準入出力ライブラリを読み込む` → `#include <___>`
  - `// プログラムのエントリーポイント（実行開始地点）を定義する` → `int ___()`
  - `// プログラムの正常終了を示す値0を返す` → `return ___;`

### 4. 指示されていない変更をしない
- 修正対象以外のコードを勝手に変更しない
- 虫食い化されている箇所を元に戻さない
- 画像パスなど既存の設定を勝手に変更しない

### 5. lineHintsの書き方
- **絶対にやってはいけないこと**：
  - `"○○と入力します"` `"○○と入力しましょう"` など答えをそのまま書くだけのヒント → 意味がない
  - 問題があるからといって安易に `null` にする → ヒントがなくなる
- **正しいヒントの書き方**：
  - その行が「何をするのか」「なぜその値を入れるのか」を説明する
  - 学習者が理解を深められる具体的な説明にする
- 良い例：
  - `"条件型で「TがUに当てはまるなら」を表すキーワードです。"`
  - `"「かつ」を表す論理演算子を使って両方の条件を満たすかチェックします。"`
  - `"Promiseの中身の型を推論して取り出すキーワードです。"`
  - `"number[]は配列なので結果はtrueになります。"`
- 悪い例：
  - `"extends と入力します。"` → 答えを言っているだけ
  - `"true と入力します。"` → 答えを言っているだけ
  - `null` → ヒントを放棄している

### 6. 修正後のDB反映
- レッスンファイル（`data/lessons/*.ts`）を修正した後は、必ず `npm run seed:db` を実行して変更をデータベースに反映させること。

### 7. 正規表現のエスケープと構文確認
- 正規表現（特に `replace` やスクリプト内）を記述する際は、文字クラス `[]` 内の `]` や `-` などの記号を正しくエスケープすること。修正後は必ずビルドが通るか、構文エラーがないかを確認すること。

### 8. 言語仕様に基づいた判定ロジック
- スペースの任意・必須判定などのコード正規化ロジックを修正する際は、一律の正規表現で処理せず、各プログラミング言語の仕様（キーワード、識別子、演算子の区別）を考慮すること。C言語の関数呼び出しのように、スペースが許容されない箇所を誤って任意扱いにしないよう注意すること。

### 9. 画像アセットの濫用禁止
- 同一のイラストを全レッスンを通して 40〜50回以上使い回すことを禁止する。
- `blueprint.png` や `gear.png` のような汎用画像に逃げず、説明内容（キーワード）に合致する専門イラストを生成・適用すること。
- コミット前に必ず画像使用頻度を分析し、特定の画像に偏りがないか確認すること。

### 10. 大規模置換時の構文安全性の確保
- 複数のレッスンファイルに対して一括置換を行う際、単純な文字列分割（`split`）や広範な正規表現を使用すると、JSON オブジェクトの構造（`{` や `}`）を破壊する恐れがある。
- 必ず置換対象のフィールド（例：`"image": ...`）をピンポイントで狙う正規表現を使用し、置換後は `npm run seed:db` 等で構文が有効であることを自動確認すること。

### 11. 配列インデックスの用語統一
- 配列やリストの要素位置を説明する際、「N番目のデータ（M番）」のような混乱を招く表現を禁止する。
- 必ず「**インデックス**」という用語を使用すること。
- **禁止表現**：
  - `2番目のデータ（1番）` → 「番目」と「番」が混在して混乱する
  - `2番目のデータ（番号は1）`
  - `N番目の番号は M です`
- **正しい表現**：
  - `2番目のデータ（インデックス1）`
  - `2番目のデータはインデックス1です`
- 解説スライドで「0番から数える」というルール説明は許可（教育目的）。

### 12. コメントは次の行を一意に特定できる内容にする
- 虫食い行の上のコメントは、次の行に何を入力すべきか一意に特定できる具体的な内容にすること。
- **禁止表現**：
  - `# メッセージを表示する` → 何を表示するか不明
  - `# 値を出力` → 何の値か不明
  - `# 処理を実行` → 何の処理か不明
  - `# 値を1つずつ返す` → 何の値か不明（`# i * 2（偶数）を返す` のように具体的に）
  - `# 値を返す` → 何の値か不明（`# nを返す` のように変数名を含める）
  - `# 値を配列に入れて返す` → 何の値か不明（`# valueを配列に入れて返す` のように）
  - `// 結果を返す` → 何の結果か不明（`// "Hello Async!"を返す` のように具体的に）
  - `// 値を持つ〜を作成` → 何の値か不明（`// 「Hello」を持つOptionalを作成` のように）
- **正しい表現**：
  - `# 「ごうかく！」と表示する` → 具体的な文字列がわかる
  - `# 「Hi, 名前!」の形式で表示` → フォーマットがわかる
  - `# scoreが80より大きいか判定` → 条件がわかる
  - `// 'Async works!'を返す` → 返す値が明確
  - `// 「Hello」を持つOptionalを作成する` → 持つ値が明確

### 13. 構文ハイライトの判定順序
- `lib/syntax-highlight.ts` の `getTokenStyle()` では、**コメント判定を文字列判定より前**に配置すること。
- 理由：コメントが `# => 'ell'` のようにクォートで終わる場合、文字列判定（`endsWithQuote`）でマッチしてしまい、コメントが文字列色で表示されてしまうため。
- 正しい判定順序：
  1. コメント（`#`, `//`, `/*`, `--`, `{-`, `;` で始まる）
  2. 文字列プレフィックス（f, r, b など）
  3. 補間ブラケット（`{`, `}`, `${`）
  4. 文字列（クォートで始まる/終わる）

### 14. レッスンファイルのimportケーシング
- `data/lessons/index.ts` でレッスンファイルをimportする際、ファイル名は**すべて小文字**で記述すること。
- **禁止**：`import { javaData3 } from './Java3';`
- **正しい**：`import { javaData3 } from './java3';`
- Windowsはファイル名の大文字小文字を区別しないが、Linux/macOSでは区別するため、ビルドエラーや本番環境でのエラーの原因になる。

### 15. holeyCodeの全コード行に虫食い（___）を含める
- `holeyCode` フィールドの**すべてのコード行**には必ず `___` を含めること。
- コメント行と空行のみ例外。構造的な行（`{`, `}`, `end`等）も虫食いにする。
- レッスンファイルを修正した後は必ず `node scripts/fix-holey-v2.mjs` を実行して虫食い化を確認すること。
- **禁止**：`package main` `import "fmt"` `using System;` など、虫食いのないコード行
- **正しい**：`package ___` `import "___"` `using ___;`

### 16. エスケープシーケンスの置換順序
- レッスンファイルの文字列をデコードする際、置換の順序が重要。
- **必ず `\\\\` を最初に置換してから `\\n` を置換すること。**
- **間違い**：`.replace(/\\n/g, '\n').replace(/\\\\/g, '\\')`
  - `\\n` (backslash-backslash-n) を処理すると、`\\n` → `\` + newline となり、余分な `\` が残る
- **正解**：`.replace(/\\\\/g, '\\').replace(/\\n/g, '\n')`
  - 先に `\\` → `\` に変換し、その後 `\n` → newline に変換

### 17. スライド/ページ切り替え時のスクロールリセット
- ページ内でスライドやコンテンツを切り替えるナビゲーション（前へ/次へボタン、ドットインジケーター等）を実装する際は、必ず切り替え時に `window.scrollTo(0, 0)` でスクロール位置をトップにリセットすること。
- 実装方法：状態変数（例：`currentSlide`）の変更を `useEffect` で監視し、変更時にスクロールリセットを実行する。
- **対象**：ページ全体のコンテンツが切り替わるスライドナビゲーション
- **対象外**：パネル内のタブ切り替え（コンソール/サンプル等）はページ全体のスクロールに影響しないため不要

### 18. correctCode / holeyCode / correctLines のコメント整合性
- `correctCode`、`holeyCode`、`correctLines` の3つのフィールドで**コメントは完全に一致**させること。
- correctCodeで具体的な値を含むコメント（例：`// "Hello Async!"を返す`）を書いた場合、holeyCodeとcorrectLinesでも同一のコメントにする。
- **禁止パターン**：
  - correctCode: `// 'Async works!'を返す` → holeyCode/correctLines: `// return で値を返す`（曖昧化）
  - correctCode: `// 「Hello」を持つOptionalを作成` → holeyCode/correctLines: `// 値を持つOptionalを作成`（曖昧化）
- **理由**：holeyCodeのコメントが曖昧だと、ユーザーが `___` に何を入力すべきか特定できない
- **修正方法**：コメントを修正する際は `correctCode`、`holeyCode`、`correctLines` の3箇所を必ず同時に更新する

### 19. 解説スライドと演習コードの差別化
- `tutorialSlides`のコード例と`correctCode`の演習コードは、**異なるシナリオ**で同じ概念を使わせること。
- **禁止**：変数名や値を変えただけでほぼ同じ構造
  - 解説: `class Point` で `x, y` を比較 → 演習: `class Vector` で `x, y` を比較
  - 解説: `Person(name)` → 演習: `Robot(name)`（属性が同じ）
- **正しい**：異なるシナリオで概念を応用させる
  - 解説: `class Point` で座標比較 → 演習: `class Book` でタイトル・著者比較
  - 解説: `Person(name)` → 演習: `Product(id, name, price)`（属性構成が異なる）
- **理由**：解説を見てそのままコピーできると学習効果がない。異なるシナリオで応用させることで理解が深まる。
- **特に注意が必要な演習**：
  - 特殊メソッド（`__eq__`, `__str__`, `toString()`, `equals()`等）
  - クラス定義の基本演習
  - デザインパターンの演習
- **チェックスクリプト**：`node scripts/check-tutorial-exercise-similarity.mjs` で類似性をチェックできる
